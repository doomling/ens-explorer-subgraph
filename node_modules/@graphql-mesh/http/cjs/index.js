"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createMeshHTTPHandler = void 0;
const cross_helpers_1 = require("@graphql-mesh/cross-helpers");
const utils_1 = require("@graphql-mesh/utils");
const server_1 = require("@whatwg-node/server");
const itty_router_1 = require("itty-router");
const itty_router_extras_1 = require("itty-router-extras");
const graphqlHandler_js_1 = require("./graphqlHandler.js");
const fetch_1 = require("@whatwg-node/fetch");
function createMeshHTTPHandler({ baseDir, getBuiltMesh, rawServeConfig = {}, playgroundTitle, }) {
    let readyFlag = false;
    let logger = new utils_1.DefaultLogger('Mesh HTTP');
    let mesh$;
    const { cors: corsConfig, staticFiles, playground: playgroundEnabled, endpoint: graphqlPath = '/graphql',
    // TODO
    // trustProxy = 'loopback',
     } = rawServeConfig;
    const serverAdapter = (0, server_1.createServerAdapter)((0, itty_router_1.Router)());
    serverAdapter.all('*', () => {
        if (!mesh$) {
            mesh$ = getBuiltMesh().then(mesh => {
                readyFlag = true;
                logger = mesh.logger.child('HTTP');
                return mesh;
            });
        }
    });
    serverAdapter.all('/healthcheck', () => new fetch_1.Response(null, {
        status: 200,
    }));
    serverAdapter.all('/readiness', () => new fetch_1.Response(null, {
        status: readyFlag ? 204 : 503,
    }));
    serverAdapter.post('*', async (request) => {
        if (readyFlag) {
            const { pubsub } = await mesh$;
            for (const eventName of pubsub.getEventNames()) {
                const { pathname } = new URL(request.url);
                if (eventName === `webhook:${request.method.toLowerCase()}:${pathname}`) {
                    const body = await request.text();
                    logger.debug(`Received webhook request for ${pathname}`, body);
                    pubsub.publish(eventName, request.headers.get('content-type') === 'application/json' ? JSON.parse(body) : body);
                    return new fetch_1.Response(null, {
                        status: 204,
                        statusText: 'OK',
                    });
                }
            }
        }
        return undefined;
    });
    if (staticFiles) {
        const indexPath = cross_helpers_1.path.join(baseDir, staticFiles, 'index.html');
        serverAdapter.get('*', async (request) => {
            const url = new URL(request.url);
            if (graphqlPath !== '/' && url.pathname === '/' && (await (0, utils_1.pathExists)(indexPath))) {
                const indexFile = await cross_helpers_1.fs.promises.readFile(indexPath);
                return new fetch_1.Response(indexFile, {
                    status: 200,
                    headers: {
                        'Content-Type': 'text/html',
                    },
                });
            }
            const filePath = cross_helpers_1.path.join(baseDir, staticFiles, url.pathname);
            if (await (0, utils_1.pathExists)(filePath)) {
                const body = await cross_helpers_1.fs.promises.readFile(filePath);
                return new fetch_1.Response(body, {
                    status: 200,
                });
            }
            return undefined;
        });
    }
    else if (graphqlPath !== '/') {
        serverAdapter.get('/', () => new fetch_1.Response(null, {
            status: 302,
            headers: {
                Location: graphqlPath,
            },
        }));
    }
    serverAdapter.all('*', itty_router_extras_1.withCookies, (0, graphqlHandler_js_1.graphqlHandler)(() => mesh$, playgroundTitle, playgroundEnabled, graphqlPath, corsConfig));
    return serverAdapter;
}
exports.createMeshHTTPHandler = createMeshHTTPHandler;
