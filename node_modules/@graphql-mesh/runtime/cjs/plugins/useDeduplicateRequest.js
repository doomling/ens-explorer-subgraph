"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useDeduplicateRequest = void 0;
const utils_1 = require("@graphql-tools/utils");
const utils_2 = require("@graphql-mesh/utils");
const fetch_1 = require("@whatwg-node/fetch");
function useDeduplicateRequest() {
    const getReqResMapByContext = (0, utils_1.memoize1)((_context) => {
        return new Map();
    });
    return {
        onFetch({ url, options = {}, context, info, fetchFn, setFetchFn }) {
            if (context !== null) {
                let method = 'GET';
                if (options.method) {
                    method = options.method;
                }
                if (method === 'GET') {
                    let headers = {};
                    if (options.headers) {
                        headers = (0, utils_2.getHeadersObj)(options.headers);
                    }
                    const acceptHeader = headers.Accept || headers.accept;
                    if (acceptHeader === null || acceptHeader === void 0 ? void 0 : acceptHeader.includes('application/json')) {
                        const reqResMap = getReqResMapByContext(context);
                        const dedupCacheKey = JSON.stringify({
                            url,
                            headers,
                        });
                        setFetchFn(() => {
                            let dedupRes$ = reqResMap.get(dedupCacheKey);
                            if (dedupRes$ == null) {
                                dedupRes$ = fetchFn(url, options, context, info).then(async (res) => ({
                                    res,
                                    resText: await res.text(),
                                }));
                                reqResMap.set(dedupCacheKey, dedupRes$);
                            }
                            return dedupRes$.then(({ res, resText }) => new fetch_1.Response(resText, res));
                        });
                    }
                }
            }
        },
    };
}
exports.useDeduplicateRequest = useDeduplicateRequest;
